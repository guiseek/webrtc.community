{"version":3,"sources":["./libs/sample/peer-to-peer/src/lib/peer-to-peer.component.ts","./libs/sample/peer-to-peer/src/lib/peer-to-peer.component.html","./libs/sample/peer-to-peer/src/lib/peer-to-peer.module.ts","./libs/sample/peer-to-peer/src/index.ts"],"names":[],"mappings":"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","file":"quertc-peer-to-peer.js","sourcesContent":["import { Subject } from 'rxjs'\nimport {\n  AfterViewInit,\n  Component,\n  ElementRef,\n  OnInit,\n  ViewChild,\n} from '@angular/core'\nimport { SignalingChannel } from '@quertc/core'\nimport { MediaStreamService } from '@quertc/shared'\n\n@Component({\n  selector: 'quertc-peer-to-peer',\n  templateUrl: './peer-to-peer.component.html',\n  styleUrls: ['./peer-to-peer.component.scss'],\n})\nexport class PeerToPeerComponent implements OnInit, AfterViewInit {\n  constraints = { audio: true, video: true }\n  pc: RTCPeerConnection\n\n  active = new Subject<boolean>()\n  active$ = this.active.asObservable()\n\n  @ViewChild('selfView') selfViewRef: ElementRef<HTMLVideoElement>\n  selfView: HTMLVideoElement\n\n  @ViewChild('remoteView') remoteViewRef: ElementRef<HTMLVideoElement>\n  remoteView: HTMLVideoElement\n\n  offerOptions: RTCOfferOptions = {\n    offerToReceiveAudio: true,\n    offerToReceiveVideo: true,\n  }\n\n  constructor(\n    private signaling: SignalingChannel,\n    private media: MediaStreamService\n  ) {}\n\n  ngOnInit(): void {}\n\n  ngAfterViewInit() {\n    this.selfView = this.selfViewRef.nativeElement\n    this.remoteView = this.remoteViewRef.nativeElement\n\n    this.pc = new RTCPeerConnection({\n      iceServers: [{ urls: 'stun:stun.stunprotocol.org:3478' }],\n    })\n\n    // send any ice candidates to the other peer\n    this.pc.addEventListener('icecandidate', ({ candidate }) => {\n      if (candidate) {\n        this.signaling.send({ candidate })\n      }\n    })\n\n    // let the \"negotiationneeded\" event trigger offer generation\n    this.pc.onnegotiationneeded = async () => {\n      try {\n        await this.pc.setLocalDescription(\n          await this.pc.createOffer(this.offerOptions)\n        )\n        // send the offer to the other peer\n        if (this.pc.localDescription) {\n          this.signaling.send({ description: this.pc.localDescription })\n        }\n      } catch (err) {\n        console.error(err)\n      }\n    }\n\n    this.pc.ontrack = ({ track, streams }) => {\n      // once media for a remote track arrives, show it in the remote video element\n      track.onunmute = () => {\n        // don't set srcObject again if it is already set.\n        if (this.remoteView.srcObject) return\n        this.remoteView.srcObject = streams[0]\n        // this.active.next(true)\n      }\n    }\n\n    this.signaling.message$.subscribe(\n      async ({ sender, description, candidate }) => {\n        try {\n          if (description) {\n            await this.pc.setRemoteDescription(description)\n            // if we got an offer, we need to reply with an answer\n            if (description.type == 'offer') {\n              if (!this.selfView.srcObject) {\n                // blocks negotiation on permission (not recommended in production code)\n                await this.addCameraMic()\n              }\n              await this.pc.setLocalDescription(await this.pc.createAnswer())\n              if (this.pc.localDescription) {\n                this.signaling.send({ description: this.pc.localDescription })\n              }\n            }\n          } else if (candidate) {\n            await this.pc.addIceCandidate(candidate)\n          }\n        } catch (err) {\n          console.error(err)\n        }\n      }\n    )\n\n    this.start()\n  }\n\n  // call start() to initiate\n  start = () => {\n    this.addCameraMic()\n  }\n\n  // add camera and microphone to connection\n  addCameraMic = async () => {\n    try {\n      // get a local stream, show it in a self-view and add it to be sent\n      this.media.currentStream = await this.media.getUserMedia(this.constraints)\n      for (const track of this.media.currentStream.getTracks()) {\n        this.pc.addTrack(track, this.media.currentStream)\n      }\n      this.selfView.srcObject = this.media.currentStream\n    } catch (err) {\n      console.error(err)\n    }\n  }\n}\n","<!-- <quertc-call-avatar [animation]=\"(active$ | async) === null\"></quertc-call-avatar> -->\n<!-- <ng-container *ngIf=\"(active$ | async) === null\">\n  <div class=\"center\">\n    <quertc-call-avatar [animation]=\"true\"></quertc-call-avatar>\n    <h3 class=\"mat-h3 mat-hint\">Convite algu√©m ou abra em outra janela</h3>\n  </div>\n</ng-container> -->\n\n<div id=\"remote\">\n  <video #remoteView autoplay></video>\n</div>\n\n<div id=\"self\">\n  <video #selfView autoplay></video>\n</div>\n","import { NgModule } from '@angular/core'\nimport { CommonModule } from '@angular/common'\nimport { RouterModule } from '@angular/router'\nimport { SharedModule } from '@quertc/shared'\nimport { PeerToPeerComponent } from './peer-to-peer.component'\n\n@NgModule({\n  imports: [\n    CommonModule,\n    SharedModule,\n    RouterModule.forChild([\n      {\n        path: '',\n        component: PeerToPeerComponent,\n      },\n    ]),\n  ],\n  declarations: [PeerToPeerComponent],\n  exports: [PeerToPeerComponent],\n})\nexport class PeerToPeerModule {}\n","export * from './lib/peer-to-peer.component'\nexport * from './lib/peer-to-peer.module'\n"],"sourceRoot":"webpack:///"}