{"version":3,"sources":["./libs/sample/perfect-negotiation/src/lib/perfect-negotiation.module.ts","./libs/sample/perfect-negotiation/src/lib/perfect-negotiation.component.ts","./libs/sample/perfect-negotiation/src/lib/perfect-negotiation.component.html","./libs/sample/perfect-negotiation/src/index.ts"],"names":[],"mappings":"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","file":"quertc-perfect-negotiation.js","sourcesContent":["import { NgModule } from '@angular/core'\nimport { CommonModule } from '@angular/common'\nimport { RouterModule } from '@angular/router'\nimport { SharedModule } from '@quertc/shared'\nimport { PerfectNegotiationComponent } from './perfect-negotiation.component'\n\n@NgModule({\n  imports: [\n    CommonModule,\n    SharedModule,\n    RouterModule.forChild([\n      {\n        path: '',\n        component: PerfectNegotiationComponent,\n      },\n    ]),\n  ],\n  declarations: [PerfectNegotiationComponent],\n})\nexport class PerfectNegotiationModule {}\n","import { PeerEvent, SignalingChannel } from '@quertc/core'\nimport { code } from '@quertc/controls'\nimport { Subject, Subscription } from 'rxjs'\nimport {\n  AfterViewInit,\n  Component,\n  ElementRef,\n  OnDestroy,\n  ViewChild,\n} from '@angular/core'\nimport { MediaStreamService } from '@quertc/shared'\n\n@Component({\n  selector: 'quertc-perfect-negotiation',\n  templateUrl: './perfect-negotiation.component.html',\n  styleUrls: ['./perfect-negotiation.component.scss'],\n})\nexport class PerfectNegotiationComponent implements AfterViewInit, OnDestroy {\n  title = 'client-app'\n\n  pc: RTCPeerConnection\n  // localStream: MediaStream\n  active = new Subject<boolean>()\n  active$ = this.active.asObservable()\n  sender = code()\n\n  subs: Subscription\n  /**\n   * manter o controle de algum estado de\n   * negociação para evitar corridas e erros\n   */\n  makingOffer = false\n  ignoreOffer = false\n  isSettingRemoteAnswerPending = false\n\n  @ViewChild('selfView') selfViewRef: ElementRef<HTMLVideoElement>\n  selfView: HTMLVideoElement\n\n  @ViewChild('remoteView') remoteViewRef: ElementRef<HTMLVideoElement>\n  remoteView: HTMLVideoElement\n\n  offerOptions: RTCOfferOptions = {\n    offerToReceiveAudio: true,\n    offerToReceiveVideo: true,\n  }\n\n  constructor(\n    private signaling: SignalingChannel,\n    public stream: MediaStreamService\n  ) {}\n\n  start = async () => {\n    try {\n      this.stream.currentStream = await this.stream.getUserMedia()\n      for (const track of this.stream.currentStream.getTracks()) {\n        this.pc.addTrack(track, this.stream.currentStream)\n      }\n      this.selfView.srcObject = this.stream.currentStream\n      this.selfView.muted = true\n    } catch (err) {\n      console.error(err)\n    }\n  }\n\n  restart = async () => {\n    this.offerOptions.iceRestart = true\n    this.makeOffer(this.offerOptions)\n  }\n\n  async makeOffer(options?: RTCOfferOptions) {\n    try {\n      this.makingOffer = true\n      await this.pc.setLocalDescription(await this.pc.createOffer(options))\n      if (this.pc.localDescription) {\n        this.signaling.send({\n          sender: this.sender,\n          description: this.pc.localDescription,\n        })\n      }\n    } catch (err) {\n      console.error(err)\n    } finally {\n      this.makingOffer = false\n    }\n  }\n\n  ngAfterViewInit() {\n    this.selfView = this.selfViewRef.nativeElement\n    this.remoteView = this.remoteViewRef.nativeElement\n\n    this.pc = new RTCPeerConnection({\n      iceServers: [{ urls: 'stun:stun.stunprotocol.org:3478' }],\n    })\n\n    this.pc.addEventListener('track', ({ track, streams }) => {\n      // assim que a mídia para uma trilha remota chegar, mostre-a no elemento de vídeo remoto\n      track.addEventListener('unmute', () => {\n        // não defina srcObject novamente se já estiver definido.\n        if (this.remoteView.srcObject) return\n        this.remoteView.srcObject = streams[0]\n        this.active.next(true)\n      })\n    })\n\n    //\n    //\n    //  A lógica de negociação perfeita, separada do resto da aplicação\n    //\n\n    // enviar qualquer candidato de gelo para o outro par\n    this.pc.addEventListener('icecandidate', ({ candidate }) => {\n      if (candidate) {\n        this.signaling.send({ sender: this.sender, candidate })\n      }\n    })\n\n    // deixe o evento \"necessário para a negociação\" gerar a oferta\n    this.pc.addEventListener('negotiationneeded', async () => {\n      this.makeOffer(this.offerOptions)\n    })\n\n    this.subs = this.signaling.message$.subscribe(\n      async ({ sender, description, candidate }) => {\n        console.log('sender: ', sender)\n        try {\n          if (description) {\n            // Uma oferta pode chegar enquanto estamos ocupados processando SRD (resposta).\n            // Nesse caso, estaremos \"estáveis\" no momento em que a oferta for processada\n            // então é seguro encadear em nossa Cadeia de Operações agora.\n            const readyForOffer =\n              !this.makingOffer &&\n              (this.pc.signalingState == 'stable' ||\n                this.isSettingRemoteAnswerPending)\n            const offerCollision =\n              description.type == PeerEvent.Offer && !readyForOffer\n\n            const polite = sender === this.sender\n\n            this.ignoreOffer = polite && offerCollision\n            if (this.ignoreOffer) {\n              return\n            }\n            this.isSettingRemoteAnswerPending =\n              description.type == PeerEvent.Answer\n\n            await this.pc.setRemoteDescription(description) // SRD reverte conforme necessário\n\n            this.isSettingRemoteAnswerPending = false\n\n            if (description.type == PeerEvent.Offer) {\n              await this.pc.setLocalDescription(await this.pc.createAnswer())\n              if (this.pc.localDescription) {\n                this.signaling.send({ description: this.pc.localDescription })\n              }\n            }\n          } else if (candidate) {\n            try {\n              await this.pc.addIceCandidate(candidate)\n            } catch (err) {\n              if (!this.ignoreOffer) throw err // Suprimir os candidatos da oferta ignorada\n            }\n          }\n        } catch (err) {\n          console.error(err)\n        }\n      }\n    )\n\n    this.start()\n  }\n\n  hangup() {\n    console.log('Ending call')\n    this.stream.currentStream.getTracks().forEach((t) => t.stop())\n    if (this.pc) {\n      this.pc.close()\n      Object.defineProperties(this.pc, {})\n    }\n  }\n\n  ngOnDestroy() {\n    this.hangup()\n    if (this.subs) {\n      this.subs.unsubscribe()\n    }\n  }\n}\n","<!-- <ng-container *ngIf=\"!!(active$ | async) === false\">\n  <div class=\"center\">\n    <quertc-call-avatar></quertc-call-avatar>\n    <h3 class=\"mat-h3 mat-hint\">Convite alguém ou abra em outra janela</h3>\n  </div>\n</ng-container> -->\n\n<div id=\"remote\">\n  <video #remoteView autoplay></video>\n</div>\n\n<div id=\"self\">\n  <video #selfView autoplay></video>\n</div>\n","export * from './lib/perfect-negotiation.component'\nexport * from './lib/perfect-negotiation.module'\n"],"sourceRoot":"webpack:///"}